<div class="profile-page">

  <!-- LEFT PANEL: PROFILE CARD -->
  <div class="profile-card left-panel" *ngIf="profileForm">
    <div class="avatar-wrapper">
      <img [src]="profileImageUrl" alt="Avatar" class="avatar" />
      <input type="file" id="avatarInput" hidden (change)="onFileSelected($event)" />
      <label for="avatarInput" class="avatar-add">+</label>
    </div>

    <form [formGroup]="profileForm">

      <!-- NAME -->
      <div class="field">
        <label>Name</label>
        <div class="field-row">
          <input formControlName="name" [readonly]="editingField !== 'name'" />
          <button *ngIf="editingField !== 'name'" type="button" class="icon-btn" (click)="editingField = 'name'">
            <img src="/icons/edit-icon.png" class="icon-img" />
          </button>
          <button *ngIf="editingField === 'name'" type="button" class="icon-btn" (click)="saveProfile()">
            <img src="/icons/check-icon.png" class="icon-img" />
          </button>
        </div>
      </div>

      <!-- LAST NAME -->
      <div class="field">
        <label>Last Name</label>
        <div class="field-row">
          <input formControlName="lastName" [readonly]="editingField !== 'lastName'" />
          <button *ngIf="editingField !== 'lastName'" type="button" class="icon-btn"
            (click)="editingField = 'lastName'">
            <img src="/icons/edit-icon.png" class="icon-img" />
          </button>
          <button *ngIf="editingField === 'lastName'" type="button" class="icon-btn" (click)="saveProfile()">
            <img src="/icons/check-icon.png" class="icon-img" />
          </button>
        </div>
      </div>

      <!-- EMAIL -->
      <div class="field">
        <label>Email</label>
        <div class="field-row">
          <input [value]="user.email" readonly />
        </div>
      </div>

      <!-- PHONE NUMBER -->
      <div class="field">
        <label>Phone Number</label>
        <div class="field-row">
          <input formControlName="phoneNumber" [readonly]="editingField !== 'phoneNumber'" />
          <button *ngIf="editingField !== 'phoneNumber'" type="button" class="icon-btn"
            (click)="editingField = 'phoneNumber'">
            <img src="/icons/edit-icon.png" class="icon-img" />
          </button>
          <button *ngIf="editingField === 'phoneNumber'" type="button" class="icon-btn" (click)="saveProfile()">
            <img src="/icons/check-icon.png" class="icon-img" />
          </button>
        </div>
      </div>

      <!-- ADDRESS -->
      <div class="field">
        <label>Address</label>
        <div class="field-row">
          <input formControlName="address" [readonly]="editingField !== 'address'" />
          <button *ngIf="editingField !== 'address'" type="button" class="icon-btn" (click)="editingField = 'address'">
            <img src="/icons/edit-icon.png" class="icon-img" />
          </button>
          <button *ngIf="editingField === 'address'" type="button" class="icon-btn" (click)="saveProfile()">
            <img src="/icons/check-icon.png" class="icon-img" />
          </button>
        </div>
      </div>

    </form>

    <div class="bottom-actions">
      <button class="change-password-btn" routerLink="/change-old-password">Change password</button>
    </div>
  </div>

  <!-- RIGHT PANEL: DRIVER -->
  <div class="right-panel driver-panel" *ngIf="userRole === 'ROLE_DRIVER'">
    <div class="info-card timer-card">
      <span class="timer-label">Active for:</span>
      <span class="timer-value">
        {{ formatMinutes(driverActivity?.minutesLast24h) }}
      </span>
    </div>

    <div class="info-card" *ngIf="vehicleInfo">
      <h3>Vehicle Information</h3>
      <div class="vehicle-grid">
        <div class="v-item"><label>Model</label>
          <div class="v-value">{{ vehicleInfo.model }}</div>
        </div>
        <div class="v-item"><label>Type</label>
          <div class="v-value">{{ vehicleInfo.vehicleType }}</div>
        </div>
        <div class="v-item"><label>Plate</label>
          <div class="v-value">{{ vehicleInfo.licensePlate }}</div>
        </div>
        <div class="v-item"><label>Seats</label>
          <div class="v-value">{{ vehicleInfo.passengerCapacity }}</div>
        </div>
        <div class="v-item"><label>Baby Transport</label>
          <div class="v-value">{{ vehicleInfo?.babyTransport ? 'Yes' : 'No' }}</div>
        </div>
        <div class="v-item"><label>Pet Transport</label>
          <div class="v-value">{{ vehicleInfo?.petTransport ? 'Yes' : 'No' }}</div>
        </div>
      </div>
    </div>

    <div class="notes-section">
      <h3>Blocked status</h3>
      <div *ngIf="blockedStatus?.blocked; else notBlocked" class="note-card blocked">
        <p>Your account is blocked</p>
        <p>{{ blockedStatus.blockReason }}</p>
      </div>

      <ng-template #notBlocked>
        <div class="note-card ok">
          <p>Your account is not blocked.</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- RIGHT PANEL: ADMIN -->
  <div class="right-panel admin-panel dashboard-card" *ngIf="userRole === 'ROLE_ADMIN'">
    <div class="dashboard-header">
      <h2>Admin Dashboard</h2>
      <button class="add-btn" routerLink="/driver-registration">+ Add Driver</button>
    </div>

    <div class="tabs-nav">
      <button class="tab-item" [class.active]="activeTab === 'approvals'"
        (click)="activeTab = 'approvals'">Approvals</button>
      <button class="tab-item" [class.active]="activeTab === 'drivers'" (click)="activeTab = 'drivers'">Drivers</button>
      <button class="tab-item" [class.active]="activeTab === 'users'" (click)="activeTab = 'users'">Passengers</button>
    </div>

    <!-- TAB CONTENT: APPROVALS -->
    <div class="table-container" *ngIf="activeTab === 'approvals'">
      <table class="custom-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Field</th>
            <th>New Value</th>
            <th style="text-align: right;">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let req of pendingRequests">
            <td>{{ req.userEmail }}</td>
            <td>{{ req.field }}</td>
            <td><ng-container *ngIf="isImageField(req.field); else textValue">
                <img [src]="getImageUrl(req.newValue)" alt="Profile change" class="preview-image" />
              </ng-container>

              <!-- Ako nije slika -->
              <ng-template #textValue>
                {{ req.newValue }}
              </ng-template>
            </td>
            <td style="text-align: right;">
              <button class="approve-btn" (click)="approveReq(req.id)">✔</button>
              <button class="reject-btn" (click)="rejectReq(req.id)">✘</button>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="pendingRequests.length === 0" style="padding: 20px; text-align: center;">No pending requests.</p>
    </div>

    <!-- TAB CONTENT: DRIVERS -->
    <div class="table-container" *ngIf="activeTab === 'drivers'">
      <table class="custom-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Blocked Reason</th>
            <th style="text-align: right;">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let driver of driversList">
            <td>{{ driver.email }}</td>
            <td>{{ driver.name }}</td>
            <td>
              <div *ngIf="driver.blocked" class="block-reason">{{ driver.blockReason }}</div>
            </td>
            <td style="text-align: right;">
              <button class="action-btn" (click)="toggleBlock(driver)" [ngClass]="driver.blocked ? 'btn-unblock' : 'btn-block'">
                {{ driver.blocked ? 'UNBLOCK' : 'BLOCK' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="driversList.length === 0" class="empty-msg">No drivers found.</p>
    </div>

    <!-- TAB CONTENT: USERS -->
    <div class="table-container" *ngIf="activeTab === 'users'">
      <table class="custom-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Blocked Reason</th>
            <th style="text-align: right;">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of usersList">
            <td>{{ user.email }}</td>
            <td>{{ user.name }}</td>
            <td>
              <div *ngIf="user.blocked" class="block-reason">{{ user.blockReason }}</div>
            </td>
            <td style="text-align: right;">
              <button class="action-btn" (click)="toggleBlock(user)" [ngClass]="user.blocked ? 'btn-unblock' : 'btn-block'" >
                {{ user.blocked ? 'UNBLOCK' : 'BLOCK' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="usersList.length === 0" class="empty-msg">No users found.</p>
    </div>

  </div>

</div>